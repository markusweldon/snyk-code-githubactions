name: Snyk Code Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  snyk:
    runs-on: ubuntu-latest
    env:
      # IMPORTANT: Set the correct regional API endpoint for your Snyk account
      # Default/Global: https://api.snyk.io
      # US: https://api.us.snyk.io
      # EU: https://api.eu.snyk.io
      # AU: https://api.au.snyk.io
      SNYK_API: https://api.snyk.io
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 🛡️ Snyk Code test (with timing)
        run: |
          echo "⏱️ Starting Snyk Code scan..."
          start_time=$(date +%s)
          snyk code test
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "⏱️ Snyk Code scan duration: $duration seconds"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: 📄 Convert Snyk output to HTML
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          REPORT_NAME="${{ github.event.repository.name }}-snyk-code-report-${TIMESTAMP}.html"
          snyk code test --json > snyk-code.json || true
          npx snyk-to-html -i snyk-code.json -o "${REPORT_NAME}"
          echo "REPORT_NAME=${REPORT_NAME}" >> $GITHUB_ENV
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: 📤 Upload HTML report artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ github.event.repository.name }}-snyk-code-report
          path: ${{ env.REPORT_NAME }}