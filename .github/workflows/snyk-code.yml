name: Snyk Code Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  snyk:
    runs-on: ubuntu-latest
    env:
      # IMPORTANT: Set the correct regional API endpoint for your Snyk account
      # Default/Global: https://api.snyk.io
      # US: https://api.us.snyk.io
      # EU: https://api.eu.snyk.io
      # AU: https://api.au.snyk.io
      SNYK_API: https://api.snyk.io
      # Set to true to fail the pipeline on high/critical severity issues (default: false)
      SNYK_CODE_FAIL_ON_ISSUES: false
    steps:
      - name: 🚀 Setup Environment
        run: echo "Setting up environment for Snyk Code scan..."
      
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Setup Snyk
        uses: snyk/actions/setup@master

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 🛡️ Snyk Code test (with timing)
        run: |
          echo "⏱️ Starting Snyk Code scan..."
          start_time=$(date +%s)
          
          # Run Snyk Code test
          # By default, the scan continues even if issues are found (exit code 0)
          # To fail on high/critical issues, set SNYK_CODE_FAIL_ON_ISSUES: true above
          if [[ "${{ env.SNYK_CODE_FAIL_ON_ISSUES }}" == "true" ]]; then
            echo "❗ Pipeline will fail if high/critical issues are found"
            snyk code test --severity-threshold=high
          else
            echo "ℹ️ Pipeline will continue regardless of issues found (default behavior)"
            snyk code test || true
          fi
          
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "🔥 SNYK CODE SCAN COMPLETED IN: $duration SECONDS 🔥"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: 📊 Generate HTML report
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          REPORT_NAME="${{ github.event.repository.name }}-snyk-code-report-${TIMESTAMP}.html"
          snyk code test --json > snyk-code.json || true
          npx snyk-to-html -i snyk-code.json -o "${REPORT_NAME}"
          echo "REPORT_NAME=${REPORT_NAME}" >> $GITHUB_ENV
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: 📤 Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-snyk-code-report
          path: ${{ env.REPORT_NAME }}

      - name: 📋 Report ready
        run: |
          echo "🎉 HTML REPORT GENERATED: ${{ env.REPORT_NAME }}"
          echo "📥 Download the report from: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"